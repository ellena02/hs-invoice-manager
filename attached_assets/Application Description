App description: Invoice Manager (Private CRM UI extension + external backend)

Invoice Manager is a private HubSpot app that adds a CRM Record Tab on the Company record.

The tab shows:

A toggle “Mark invoices as bad debt” that sets/unsets a flag on the company property bad_debt (single checkbox).

Two tables:

Associated Deals (objectTypeId 0-3)

Associated Invoices (objectTypeId 0-53)

Because the project is on platform version 2025.2, HubSpot app functions / serverless functions are not used for this flow. Instead, the toggle calls an external backend endpoint via hubspot.fetch().

Backend

The backend:

receives companyId + badDebt

uses a Private App Access Token (scope: crm.objects.companies.write)

updates the company property:

bad_debt = "true" when the toggle is ON

bad_debt = "false" when the toggle is OFF

A) Backend code (Node/Express) – /mark-bad-debt
package.json
{
  "name": "invoice-manager-backend",
  "version": "1.0.0",
  "type": "module",
  "main": "index.js",
  "scripts": {
    "start": "node index.js"
  },
  "dependencies": {
    "@hubspot/api-client": "^9.0.0",
    "cors": "^2.8.5",
    "dotenv": "^16.4.0",
    "express": "^4.19.0"
  }
}

index.js
import express from "express";
import cors from "cors";
import dotenv from "dotenv";
import { Client as HubSpotClient } from "@hubspot/api-client";

dotenv.config();

const app = express();
const port = process.env.PORT || 3000;

const HS_PRIVATE_APP_TOKEN = process.env.HS_PRIVATE_APP_TOKEN;
if (!HS_PRIVATE_APP_TOKEN) {
  console.error("Missing HS_PRIVATE_APP_TOKEN env var.");
  process.exit(1);
}

const hubspotClient = new HubSpotClient({ accessToken: HS_PRIVATE_APP_TOKEN });

app.use(cors());
app.use(express.json());

app.post("/mark-bad-debt", async (req, res) => {
  try {
    const { companyId, badDebt } = req.body || {};

    if (!companyId) {
      return res.status(400).json({ success: false, message: "Missing companyId." });
    }

    const isChecked =
      badDebt === true || badDebt === "true" || badDebt === 1 || badDebt === "1";

    const newValue = isChecked ? "true" : "false"; // single checkbox expects "true"/"false"

    await hubspotClient.crm.companies.basicApi.update(companyId, {
      properties: { bad_debt: newValue },
    });

    return res.status(200).json({ success: true, bad_debt: newValue });
  } catch (error) {
    console.error("Backend mark-bad-debt error:", error?.response?.body || error);
    return res.status(500).json({
      success: false,
      message:
        error?.response?.body?.message || error?.message || "Unexpected backend error.",
    });
  }
});

app.get("/health", (req, res) => res.json({ ok: true }));

app.listen(port, () => console.log(`Backend listening on :${port}`));

.env (local)
HS_PRIVATE_APP_TOKEN=PASTE_PRIVATE_APP_ACCESS_TOKEN_HERE
PORT=3000


Endpoint after deploy (example):

POST https://<your-backend-host>/mark-bad-debt

B) HubSpot UI extension (CRM tab) – updated code without serverless
1) Update app-hsmeta.json (permittedUrls.fetch)

Add your backend URL origin to the fetch allowlist.

Before:

"permittedUrls": {
  "fetch": ["https://api.hubapi.com"],
  "iframe": [],
  "img": []
}


After (example):

"permittedUrls": {
  "fetch": [
    "https://api.hubapi.com",
    "https://invoice-manager-backend.onrender.com"
  ],
  "iframe": [],
  "img": []
}


⚠️ It must be the exact origin (no path), e.g. https://invoice-manager-backend.onrender.com

2) Replace cards/invoice-manager.tsx with this code

This version:

removes runServerlessFunction

adds hubspot.fetch to call the backend

import React, { useState } from "react";
import { hubspot, Toggle, Text, Flex, Divider, Alert } from "@hubspot/ui-extensions";
import { CrmAssociationTable } from "@hubspot/ui-extensions/crm";

type InvoiceManagerProps = {
  context: any;
};

// ✅ CHANGE THIS to your deployed backend URL:
const BACKEND_ORIGIN = "https://invoice-manager-backend.onrender.com";
const MARK_BAD_DEBT_URL = `${BACKEND_ORIGIN}/mark-bad-debt`;

const InvoiceManagerCard: React.FC<InvoiceManagerProps> = ({ context }) => {
  const companyId: string | undefined = context?.objectId || context?.crm?.objectId;

  const initialBadDebt: boolean =
    context?.properties?.bad_debt === "true" ||
    context?.crm?.properties?.bad_debt === "true";

  const [badDebt, setBadDebt] = useState<boolean>(initialBadDebt);
  const [loading, setLoading] = useState(false);
  const [serverError, setServerError] = useState<string | null>(null);
  const [successMessage, setSuccessMessage] = useState<string | null>(null);

  const handleToggleChange = async (checked: boolean) => {
    if (!companyId) {
      setServerError("Missing company ID in context.");
      return;
    }

    setLoading(true);
    setServerError(null);
    setSuccessMessage(null);

    // optimistic UI
    setBadDebt(checked);

    try {
      const response = await hubspot.fetch(MARK_BAD_DEBT_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: {
          companyId,
          badDebt: checked,
        },
      });

      const body = await response.json();

      if (!body?.success) {
        setServerError(body?.message || "Backend returned an error.");
        // optional rollback:
        // setBadDebt(!checked);
      } else {
        setSuccessMessage("Bad debt status updated successfully.");
      }
    } catch (error: any) {
      console.error("Error calling backend:", error);
      setServerError(error?.message || "Failed to call backend.");
      // optional rollback:
      // setBadDebt(!checked);
    } finally {
      setLoading(false);
    }
  };

  return (
    <Flex direction="column" gap="medium">
      <Text format={{ fontWeight: "bold" }}>Invoice Manager</Text>

      <Flex direction="row" align="center" gap="small">
        <Toggle
          label="Mark invoices as bad debt"
          checked={badDebt}
          onChange={handleToggleChange}
        />
        {loading && <Text>Updating...</Text>}
      </Flex>

      {serverError && (
        <Alert variant="error" title="Error">
          {serverError}
        </Alert>
      )}

      {successMessage && (
        <Alert variant="success" title="Success">
          {successMessage}
        </Alert>
      )}

      <Divider />

      <Text format={{ fontWeight: "bold" }}>Associated Deals</Text>
      <CrmAssociationTable
        objectTypeId="0-3"
        propertyColumns={["dealname", "amount", "dealstage", "closedate"]}
        searchable={true}
        pagination={true}
        pageSize={10}
      />

      <Divider />

      <Text format={{ fontWeight: "bold" }}>Associated Invoices</Text>
      <CrmAssociationTable
        objectTypeId="0-53"
        propertyColumns={["hs_invoice_number", "hs_invoice_status", "amount"]}
        searchable={true}
        pagination={true}
        pageSize={10}
      />
    </Flex>
  );
};

hubspot.extend<"crm.record.tab">(({ context }: any) => (
  <InvoiceManagerCard context={context} />
));

C) Checklist to make it work

Backend is deployed and working:

GET /health returns { ok: true }

POST /mark-bad-debt works in Postman/curl

HubSpot project setup:

app-hsmeta.json includes the backend origin in permittedUrls.fetch

cards/invoice-manager.tsx uses hubspot.fetch and calls the correct backend URL

Deploy:

hs project build + hs project deploy

App installed + tab is visible on the Company record
